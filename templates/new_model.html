<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Страница для создания новой модели</title>
    <link rel="stylesheet" type="text/css" href="/static/styles/general.css" />
    <link rel="stylesheet" type="text/css" href="/static/styles/new_model.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous"/>
</head>
<body>
<form action="/logout" method="get">
    <div id="logout-form">
        <input type="submit" id="logout-button" value="Выйти">
        <p>{{ name }}</p>
        <p>{{ surname }}</p>
    </div>
</form>
<div class="d-flex flex-column align-items-center">
    <h1>Создание модели</h1>
    {% if state is undefined %}
        {% if saved is defined and saved == 1 %}
            <p class="first_p">Модель сохранена!</p>
        {% elif saved is defined and saved == 2 %}
            <p class="first_p">Модель обновлена!</p>
        {% endif %}
        <form action="/index" method="get">
            <input type="submit" value="На главную">
        </form>
        <form action="/new_model_page/0" method="post">
            <input type="submit" value="Создать новую модель">
        </form>
        <h2>ИЛИ</h2>
        <p>Продолжить создание незавершённой модели</p>
        <div class="container">
            <label for="modelsTable">Незавершённые модели:</label>
            <table id="modelsTable" class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Название модели</th>
                        <th>ТП</th>
                        <th>Автор</th>
                        <th>Дата создания</th>
                        <th>Метод</th>
                        <th>Описание модели</th>
                        <th>Последнее изменение и пользователь</th>
                        <th>Статус модели</th>
                        <th>Переобучена раз</th>
                        <th>Метод моделирования</th>
                        <th>Использование в калькуляторе</th>
                        <th>Сколько раз была переобучена</th>
                        <th>Ссылка на оригинал модели, если копия</th>
                        <th>Финализация модели</th>
                    </tr>
                </thead>
                <tbody>
                    {% for model in all_models %}
                    <tr>
                        <td><a href="/new_model_continue/{{ model.id }}/{{ model.state + 1 }}"><b>"{{ model.name }}"</b></a></td>
                        <td><b>{{ get_prof_name(model.profession) if model.profession else 'не указана' }}</b></td>
                        <td><b>{{ model.author_id.last_name }} {{ model.author_id.first_name }}</b></td>
                        <td><b>{{ model.creation_on }}</b></td>
                        <td><b>{{ model.method_id.name if model.method_id.name else 'не указан' }}</b></td>
                        <td><b>{{ model.description }}</b></td>
                        <td><b>{{ model.updated_on }}</b>, <b>{{ model.last_changed_user.last_name }} {{ model.last_changed_user.first_name }}</b></td>
                        <td>
                            <b>
                            {% if model.state == 0 %}
                                Создана запись о модели в БД
                            {% elif model.state == 1 %}
                                Выбран метод моделирования
                            {% elif model.state == 2 %}
                                Выбраны гиперпараметры метода моделирования
                            {% elif model.state == 3 %}
                                Модель обучена
                            {% elif model.state == 4 %}
                                Скорректированы отрицательные значения
                            {% elif model.state == 5 %}
                                Модель финализирована
                            {% elif model.state == 6 %}
                                Модель используется
                            {% else %}
                                Неизвестный статус
                            {% endif %}
                            </b>
                        </td>
                        <td><b>{{ model.retrained }}</b></td>
                        <td><b>{{ model.method }}</b></td>
                        <td><b>{{ model.used }}</b></td>
                        <td><b>{{ model.retrained }}</b></td>
                        <td><b>{{ model.orig }}</b></td>
                        <td><b>{{ model.finalized }}</b></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
    {% elif state == 0 %}
        <h2>Добавление записи модели</h2>
        {% if model is defined %}
            <h2>Изменение модели</h2>
        {% endif %}
        <form action="/new_model_page" method="get">
            <input type="submit" value="Назад">
        </form>
        <form action="/new_model_page/1" method="post" id="form-state-0">
            <label value="Название модели">Название модели
                <input type="text" name="model_name" required value="{{ model.name if model is defined else '' }}">
            </label>
            <label>Типовая позиция
                {% if prof_list is defined %}
                    <select name="profession" >
                    {% for prof in prof_list %}
                        <option value="{{prof}}">{{prof}}</option>
                    {% endfor %}
                {% elif model is defined %}
                    <input type="text" name="profession" disabled value="{{ get_prof_name(model.profession) }}" id="author">
                {% endif %}
                </select>
            </label>
            <label value="Описание модели" for="model_description">Описание модели
                <textarea type="text" class="form-control form-control-lg" name="model_description"
                          oninput="document.querySelector('input#id').value = this.value;"
                          id="model_description">{{ model.description if model is defined else '' }}</textarea>
            </label>
            <label value="Автор">Автор
                <input type="text" disabled value="{{ surname }} {{ name }}" id="author">
            </label>
            {% if model is defined %}
                <input type="hidden" name="defined_model" value="{{ model.id }}">
            {% endif %}
            <input type="submit" name="continue" value="Продолжить">
            <input type="submit" name="continue" value="Сохранить и закрыть">
        </form>
    {% elif state == 1 %}
        <h2>Выбор метода моделирования</h2>
        {% if model is defined %}
            <h2>Изменение модели</h2>
        {% endif %}
        <form action="/new_model_page" method="get">
            <input type="submit" value="На главную">
        </form>
        <form action="/new_model_continue/{{ model.id }}/0" method="get">
            <input type="submit" value="Назад">
        </form>
        <form action="/new_model_page/2" method="post" id="form-state-0">
            <label>Метод моделирования
                {% if method_change_allowed is defined and method_change_allowed and method is defined %}
                    <input type="text" name="model_method" disabled value="{{ method }}">
                {% else %}
                    <select name="model_method">
                        <option value="CatBoostRegressor">CatBoostRegressor</option>
                    </select>
                {% endif %}
            </label>
            <input type="hidden" name="model" value="{{ model.id }}">
            <input type="submit" name="continue" value="Продолжить">
            <input type="submit" name="continue" value="Сохранить и закрыть">
        </form>
    {% elif state == 2 %}
        <h2>Выбор гиперпараметров метода</h2>
        <form action="/new_model_page" method="get">
            <input type="submit" value="На главную">
        </form>
        <form action="/new_model_continue/{{ model.id }}/1" method="get">
            <input type="submit" value="Назад">
        </form>
            <p>Профессия: {{ get_prof_name(model.profession) }}</p>
            <p>Модель: {{ method }}</p>
        <form action="/new_model_page/3" method="post" id="form-state-0">
            {% if method == 'CatBoostRegressor' %}
                <label value="Количество эпох">Количество эпох:
                    <input type="number" name="epochs" value="1000" required min="1">
                </label>
                <label value="Ранняя остановка">Ранняя остановка:
                    <input type="number" name="early_stop" value="100" required min="1">
                </label>
                <label value="Разбиение train/test (процент тестовых данных)">Разбиение train/test:
                    <input type="number" name="train_test" value="0.25" required min="0.01" max="1" step="0.01">
                </label>
                <label value="learning rate">Скорость обучения:
                    <input type="number" name="learning_rate" value="0.03" required step="0.01">
                </label>
                <label value="depth">Глубина модели:
                    <input type="number" name="depth" value="6" required min="1" max="16">
                </label>
            {% endif %}
            <input type="hidden" name="model" value="{{ model.id }}">
            <input type="submit" name="continue" value="Продолжить" disabled>
            <input type="submit" name="continue" value="Сохранить и закрыть">
        </form>
    {% endif %}
{##}
{#    <p class="text-info-main">Выберите параметры конфигурации Виртуальной машины для обучения модели:</p>#}
{#    <label value="param1">#}
{#        <p>Параметр 1:</p>#}
{#        <input type="number" name="param1" value="0.02">#}
{#    </label>#}
{#    <label value="param2">#}
{#        <p>Параметр 2:</p>#}
{#        <input type="number" name="param2" value="7">#}
{#    </label>#}
{#    <label value="param3">#}
{#        <p>Параметр 3:</p>#}
{#        <input type="number" name="param3" value="23">#}
{#    </label>#}
{#    <input type="submit" value="Сохранить">#}
{#    <input type="submit" value="Обучить модель">#}
{##}
{#    <p>Полученные метрики модели:</p>#}
{#    <p>Метрика 1:</p>#}
{#    <p>{{ metric1 }}</p>#}
{#    <p>Метрика 2:</p>#}
{#    <p>{{ metric2 }}</p>#}
{#    <input type="submit" value="Сохранить">#}
{##}
{#    <p>ФОРМА ДЛЯ НАСТРОЙКИ ПАРАМЕТРОВ АЛГОРИТМА КОРРЕКТИРОВКИ (в разработке):</p>#}
{#    <input type="submit" value="Сохранить">#}
{#    <input type="submit" value="Вернуться назад">#}
{#    <input type="submit" value="Запустить корректировку">#}
{#    <p>progressbar</p>#}
{##}
{#    <p>Обновлённые метрики модели:</p>#}
{#    <p>Метрика 1:</p>#}
{#    <p>{{ metric1 }}</p>#}
{#    <p>Метрика 2:</p>#}
{#    <p>{{ metric2 }}</p>#}
{#    <input type="submit" value="Сохранить">#}
{##}
{#    <input type="submit" value="Сохранить в хранилище">#}
{##}
{#    <form action="/index" method="get" style="margin-bottom: 50px;">#}
{#        <input type="submit" value="Финализировать и закрыть">#}
{#    </form>#}
</div>
</body>
</html>